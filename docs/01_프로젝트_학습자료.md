# 프로젝트 학습 자료 (면접 대비)

> 이 문서를 읽으면 프로젝트 전체를 15분 안에 파악할 수 있습니다.

---

## 1. 프로젝트 한 줄 요약

**"DICOM/X-ray 영상에 CLAHE, Canny Edge 전처리를 적용하고 Before/After를 비교하는 웹 도구"**

---

## 2. 시스템 아키텍처 (외워야 함)

```
┌─────────────────────────────────────────────────────────────────┐
│                        사용자 브라우저                            │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Streamlit (app.py)                     │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐               │   │
│  │  │파일 업로드│→│전처리 선택│→│Before/After│               │   │
│  │  └──────────┘  └──────────┘  └──────────┘               │   │
│  └──────────────────────┬───────────────────────────────────┘   │
│                         │                                        │
│                         ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              preprocess_core.py (핵심 로직)                │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐         │   │
│  │  │dicom_to_pil│  │apply_clahe │  │ apply_edge │         │   │
│  │  └────────────┘  └────────────┘  └────────────┘         │   │
│  └──────────────────────────────────────────────────────────┘   │
│                         │                                        │
│                         ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  FastAPI (api.py)                         │   │
│  │              POST /preprocess → Base64 PNG                │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 면접 질문: "시스템 구조를 설명해주세요"
**답변**:
- Streamlit으로 웹 UI 제공 (파일 업로드, 파라미터 조절, 결과 표시)
- preprocess_core.py에 순수 함수로 이미지 처리 로직 분리
- FastAPI로 REST API 제공 (외부 시스템 연동 가능)
- 모듈 분리로 재사용성과 테스트 용이성 확보

---

## 3. 핵심 모듈 3개 (반드시 숙지)

### 3.1 preprocess_core.py (핵심 이미지 처리)

**역할**: DICOM/이미지 로딩 및 전처리 알고리즘 구현

**주요 함수**:
| 함수명 | 역할 | 입력 → 출력 |
|--------|------|-------------|
| `dicom_to_pil()` | DICOM → PIL 변환 | bytes → (PIL.Image, Dataset) |
| `load_image()` | PNG/JPG/BMP → PIL | bytes → PIL.Image |
| `apply_clahe()` | CLAHE 대비 향상 | PIL.Image → PIL.Image |
| `apply_edge()` | Canny 에지 검출 | PIL.Image → PIL.Image |
| `apply_window_level()` | Window Level 적용 | np.array → np.array |

**핵심 코드 - DICOM 처리 (40~87행)**:
```python
def dicom_to_pil(file_bytes, normalize_mode="minmax"):
    dcm = pydicom.dcmread(BytesIO(file_bytes))
    img_raw = dcm.pixel_array.astype(np.float32)

    # RescaleSlope/Intercept 적용 (DICOM 표준)
    if 'RescaleSlope' in dcm and 'RescaleIntercept' in dcm:
        img = img_raw * slope + intercept

    # Window Level 또는 Min/Max 정규화
    if normalize_mode == "window":
        img_normalized = apply_window_level(img, wc, ww)
    else:
        img_normalized = (img - img.min()) / (img.max() - img.min()) * 255
```

**핵심 코드 - CLAHE (89~104행)**:
```python
def apply_clahe(pil_img, clip_limit=2.0, tile_grid_size=8):
    gray = cv2.cvtColor(np.array(pil_img), cv2.COLOR_RGB2GRAY)
    clahe = cv2.createCLAHE(clipLimit=clip_limit,
                            tileGridSize=(tile_grid_size, tile_grid_size))
    cl = clahe.apply(gray)
    return Image.fromarray(cv2.cvtColor(cl, cv2.COLOR_GRAY2RGB))
```

### 면접 질문: "CLAHE가 무엇인가요?"
**답변**:
1. Contrast Limited Adaptive Histogram Equalization
2. 이미지를 타일로 나눠 각 영역별로 히스토그램 평활화
3. clipLimit으로 과도한 대비 증폭 제한
4. 의료영상의 저대비 영역 세부사항 개선에 효과적

---

### 3.2 app.py (Streamlit UI)

**역할**: 웹 인터페이스 및 사용자 인터랙션 처리

**주요 기능**:
| 기능 | 구현 방식 |
|------|----------|
| 파일 업로드 | `st.sidebar.file_uploader()` |
| 모드 선택 | `st.sidebar.radio()` |
| 파라미터 튜닝 | `st.sidebar.slider()` |
| Before/After | `st.columns()` + `st.image()` |
| 메타데이터 표시 | HTML 테이블 + `st.markdown()` |

**핵심 코드 - 캐싱 (407~411행)**:
```python
@st.cache_data
def load_dicom_image(file_bytes, norm_mode):
    """DICOM 로딩 결과 캐싱 → 파라미터 변경 시에도 재로딩 방지"""
    img, dcm = dicom_to_pil(file_bytes, norm_mode)
    return img, dcm
```

### 면접 질문: "왜 @st.cache_data를 사용했나요?"
**답변**:
1. DICOM 파일 로딩은 비용이 큼 (파싱 + 변환)
2. 전처리 파라미터 변경 시마다 재로딩하면 느림
3. 캐싱으로 같은 파일/모드면 즉시 반환
4. 사용자 경험 개선 (실시간 파라미터 튜닝 가능)

---

### 3.3 api.py (FastAPI REST API)

**역할**: HTTP 기반 이미지 전처리 서비스

**엔드포인트**:
```
POST /preprocess
  - file: DICOM/이미지 파일
  - mode: "원본만 보기" | "CLAHE 대비 향상" | "에지 검출(Canny)"
  - normalize_mode: "minmax" | "window"
  - clip_limit, tile_grid_size, canny_t1, canny_t2

  → Response: {status, mode, params, dicom_metadata, image_data: {base64_string}}
```

### 면접 질문: "왜 FastAPI를 추가했나요?"
**답변**:
1. Streamlit은 대화형 UI에 특화, 프로그래밍 방식 접근 어려움
2. FastAPI로 REST API 제공 → 다른 시스템에서 호출 가능
3. 배치 처리, 자동화 파이프라인 연동 가능
4. preprocess_core.py 재사용으로 로직 중복 없음

---

## 4. 핵심 알고리즘 설명 (면접 필수)

### 4.1 DICOM Window Level

**개념**: 특정 조직을 강조하기 위해 픽셀값 범위를 조절

```
Window Center (WC): 관심 영역의 중심값
Window Width (WW): 표시할 픽셀값 범위

min = WC - WW/2
max = WC + WW/2
→ [min, max] 범위를 0-255로 매핑
```

**예시**:
| 조직 | Window Center | Window Width |
|------|---------------|--------------|
| 폐 | -600 | 1500 |
| 뼈 | 300 | 1500 |
| 연조직 | 40 | 400 |

### 면접 질문: "Window Level이 왜 필요한가요?"
**답변**:
1. DICOM 원본은 넓은 픽셀값 범위 (예: -1000 ~ +3000)
2. 모니터는 0-255만 표시 가능
3. 전체 범위를 압축하면 대비 낮아짐
4. 관심 조직에 맞는 Window로 해당 영역만 강조

---

### 4.2 CLAHE vs 일반 히스토그램 평활화

| 구분 | 일반 HE | CLAHE |
|------|---------|-------|
| 처리 단위 | 전체 이미지 | 타일 단위 |
| 대비 제한 | 없음 | clipLimit으로 제한 |
| 노이즈 증폭 | 심함 | 제한적 |
| 의료영상 적합성 | 낮음 | 높음 |

---

### 4.3 Canny Edge Detection

**3단계 과정**:
1. **가우시안 블러**: 노이즈 제거
2. **그래디언트 계산**: Sobel 연산자로 경계 강도/방향 계산
3. **이중 임계값**: threshold1(약한 에지), threshold2(강한 에지)

```python
edges = cv2.Canny(gray, threshold1=50, threshold2=150)
# threshold1 이하: 에지 아님
# threshold2 이상: 확실한 에지
# 사이값: 강한 에지와 연결되면 에지로 인정
```

---

## 5. 핵심 설계 결정 (면접 필수)

### Q1: 왜 preprocess_core.py를 분리했나요?
**답변**:
- 순수 함수로 분리 → 테스트 용이
- Streamlit과 FastAPI에서 동일 로직 재사용
- 새 알고리즘 추가 시 한 곳만 수정

### Q2: 왜 RGB로 변환해서 반환하나요?
**답변**:
- Streamlit `st.image()`가 RGB 기대
- 그레이스케일도 RGB로 통일 → 일관된 처리
- 후속 처리에서 채널 불일치 방지

### Q3: DICOM 메타데이터는 왜 추출하나요?
**답변**:
- Patient ID, Modality 등 의료 정보 표시
- Window Center/Width 자동 적용에 필요
- 임상 환경과 유사한 사용자 경험 제공

### Q4: 왜 Min/Max와 Window Level 두 가지 모드를 제공하나요?
**답변**:
- Min/Max: 전체 데이터 확인용 (디버깅, 탐색)
- Window Level: 임상 표준 (의사가 보는 방식)
- 사용 목적에 따라 선택 가능

---

## 6. 에러 처리 패턴

### 패턴 1: ValueError로 명확한 에러 메시지
```python
def dicom_to_pil(file_bytes, normalize_mode):
    try:
        dcm = pydicom.dcmread(BytesIO(file_bytes))
        ...
    except Exception as e:
        raise ValueError(f"DICOM 파일 처리 실패: {e}")
```

### 패턴 2: Window 정보 없으면 fallback
```python
if wc is not None and ww is not None and float(ww) > 0:
    img_normalized = apply_window_level(img, wc, ww)
else:
    normalize_mode = "minmax"  # Fallback
```

### 패턴 3: 다중값 처리
```python
# WindowCenter/Width가 리스트일 경우 첫 번째 값 사용
if isinstance(wc, (list, tuple)): wc = wc[0]
```

---

## 7. 기술 스택 정리

| 분류 | 기술 | 용도 |
|------|------|------|
| 언어 | Python 3.8+ | 전체 |
| 웹 UI | Streamlit | 대화형 인터페이스 |
| REST API | FastAPI | 외부 연동 |
| 이미지 처리 | OpenCV, Pillow | 전처리 알고리즘 |
| DICOM | pydicom | 의료영상 파싱 |

---

## 8. 도메인 지식 활용 포인트

### 방사선사 면허 보유자로서:
- DICOM 표준 구조 이해 (Tag, VR, 메타데이터)
- Window Level 개념과 임상 적용 방식 숙지
- X-ray 영상 특성 (노이즈, 대비, 해부학적 구조)

### 의료영상 학사로서:
- 영상 전처리가 진단에 미치는 영향 이해
- CLAHE가 저대비 영역에 효과적인 이유 설명 가능
- 에지 검출이 해부학적 구조 분석에 유용한 이유

---

## 9. 빠른 복습 체크리스트

- [ ] 시스템 아키텍처 그림 그릴 수 있는가?
- [ ] preprocess_core.py의 4개 함수 역할 설명 가능한가?
- [ ] CLAHE 파라미터 (clipLimit, tileGridSize) 의미 설명 가능한가?
- [ ] Window Level (WC, WW) 개념 설명 가능한가?
- [ ] 모듈 분리 이유 설명 가능한가?
- [ ] @st.cache_data 사용 이유 설명 가능한가?

---

## 10. 면접 예상 질문 정리

### 기술 질문
| 질문 | 답변 포인트 |
|------|-------------|
| CLAHE란? | 타일 단위 히스토그램 평활화, clipLimit으로 노이즈 제한 |
| Window Level이란? | 관심 조직 강조를 위한 픽셀값 범위 조절, WC/WW |
| 왜 Streamlit + FastAPI 둘 다? | UI + API 이중 인터페이스, 재사용성 |
| pydicom 선택 이유? | Python DICOM 표준 라이브러리, 메타데이터 접근 용이 |

### 프로젝트 질문
| 질문 | 답변 포인트 |
|------|-------------|
| 프로젝트 시작 계기? | 의료영상 도메인 지식 + 프로그래밍 결합, 포트폴리오 |
| 어려웠던 점? | DICOM 다중값 처리, Window Level fallback 로직 |
| 개선하고 싶은 점? | 추가 알고리즘 (Gaussian, Morphology), 배치 처리, GPU 가속 |
